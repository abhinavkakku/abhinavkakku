---
title: Malware Analysis
date: 2023-09-04
author: Abhinav Kumar
image: {
  src: "/images/htb-bashed.png",
  alt: "HackTheBox Bashed Walkthrough",
}
description: Malware Analysis Topics
draft: true
category: RE
---


User Mode vs Kernal Mode
E-Stack vs K-Stack
WinDBG

Windows Process
What is Process
E-Process Structure
K_Process Structure

WinDBG
dt nt!_EPROCESS
dt nt!_KPROCESS
!dml_proc [AddressInMemory, PID ,ImageFileName]
dt nt!_EPROCESS AddressInMemory

What are Threads
EProcess Holds the information on Threads for a process
Number fo threds - ThreadCount in E_Process
Point_to_Thread_List --> E_Thread 
Kernel Specific Info is Present in Ethread
dt nt!_ETHREAD
dt nt!_KTHREAD


Windows Services
Local Sessions Manager
Microsoft Defender Service

Access Control Lists
icacls <filename>
SD #Security Descriptor is attached to program when run
!process 0 0 notepad.exe
!object <address_space_of_Notepad>
dt nt!_object_header <address of object>
!sd <security descriptor from object header> & -10 
wmic useraccount get name,sid

Uwer and group is assigned a security Identified - SID
S-Revision-X-Y1-Y2-Yn-RID - Security Identifier, Revision, Domain, Relative Identifier
User Account RID > 1000
System Account RID < 1000
For  many known system accounts SID is predefined, can be read of MSTF Docs
Token field in E_Process has SID
the SID is stored by SUbstraction of Object - RefCnt value
dt nt!_TOKEN <Address>
User and Groups --> SID
!sid object address
Virtual Memory
page memory

Windows API Functions to do with Virtual Memory
VirtualAllocEx
VirtualProtectEx
VirtualLock
VirtualUnlock
VirtualQuery



Shared Memory
Windows API Functions to do with Shared Memory
CreateFileMapping
OpenFileMapping
MapViewOfFile
UnMaViewOfFile


Drivers
driveryquery
unually PE files like .sys 
WInDBG- lm t n (list loaded modules)
dt nt!_DRIVER_OBJECT 
More Windows Drivers related research to be done

Windows Job
set of process that control resources to these process.
DBG --> !job <object>

!handle processname -> to view the handles/objects/files by the application


Windows Registry
stored as files on disk as - sys32/config
reg query via commandline to access
for DBG
!reg hivelist
!reg querykey \REGISTR\MACHINE\HARDWARE\


Elevation
UAC

APIs
CreateProcessWithLogonW
ShellExecute
IsUserAnAdmin
OpenProcessToken
AdjustTokenPrivileges

Windows Access Tokens

Privileges decide what can be done
Process Privileges
SeLoadDriverPrivilege
SeMachineAccountPrivilege
SeShutdownPrivilege


Remote Procedure Calls
rpcrt4.dll
rpcns4.dll
rpcproxy.dll 

APIs
RpcBindingCreate
RpcNsBindingExport
RpcServerListen
RpcSetBindingAuthInfo
RpcBindingFree


Windows APIs
prefix - Create Get Set Open Close
Keyword - Reg, File, Process, Library
Suffix - Ex - Extended, A- ASCII, W - Unicode


SystemCalls
Low Level Functions
Often Prefixed with Nt
some with Zw 


API Manage Process and Threads
CreateProcess()
OpenProcess()
TerminateProcess()
SetPriorityClass()
OpenProcessToken()
CreateThread()
SetThreadContext()
GetThreadPriority()


API to Manage Memory
VirtualAlloc()
VirtualFree()
VirtualProtect()
LocalAlloc()
LocalProtect()
HeapFree()
HeapCreate()

File APIs

CreateFile()
ReadFile()
WriteFile()
DeleteFile()
SetFileAttributes()
GetFilePointer()
GetTempPath()
CreateHardLink()

Static Analysis
Without running the binary
- Hash Value and check Open Sources
- Strings Analysis using strings and Floss
- PEView lets us check the Binary, 
- Virtual Size and Size of Raw Data difference indicate Packed binary
- IAT - Import Address Table

- PEStudio

Malware Types
Dropper/Downloader
- Keylogger/ Infostealer
- Bot (Spam)
- Banker
- Worm
- Ransomware
- Miner
- Backdoor

APIs for KeyLoggers
- GetAsyncKeyState
- SetWindowsHookEx
- GetForegroundWindow

Things to look for in InfoStealer
- SQLite3 Usage
- Firefox Dll Usage (nss, mozglue)
- Calls to CryptUnprotectData()


APIs for Banker
- HTTPSendRequest


Worm
- Utilise vulnerabilities and almost 0 interaction required to spread.


Ransomware

API Calls in Malwares Analysis for 
- Networking
-- WSAStartup(), socket(), server: bind(), listen(), accept(), connect(), send(), recv(), WSACleanup()
- Registry Persistence
-- RegCreateKeyEx , RegOpenKeyEx, RegSetValueEx , RegDeleteKeyEx, RegGetValueEx
- File Persistence
-- GetTempPath, CopyFile, CreateFile, WriteFile, ReadFile
- Service Persistence
-- OpenSCManager, CreateService, StartServiceCtrlDispatcher
- Encryption WinCrypt API
-- CryptAcquireContext, CryptGenKey, CryptDestroyKey, CryptDeriveKey, CryptEncrypt, CryptDecrypt, CryptReleaseContext
- Anti-Analysis/ Anti VM
-- IsDebuggerPresent, GetSystemInfo, GlobalMemoryStatusEx, GetVersion, 
-- Assembly Instruction - CPUID(), IN(), 
- Stealth 
-- VirtualAlloc, VirtualProtect, ReadProcessMemory, WriteProcessMemory, CreateRemoveThread, NtUnmapViewOfSection, QueueUserAPC
- Execution API
-- CreateProcess, ShellExecute, WinExec, ResumeThread
- Miscellanous
-- GetAsyncKeyState, SetWindowsHookEx, GetForeGroundWindow, LoadLibrary, getProcAddress, CreateToolHelp32Snapshot, getDC, BitBlt, IntenetOpen, InternetOpenURL, InternetReadFile, InternetWriteFile, FindResource, ReadResource, WriteResource

